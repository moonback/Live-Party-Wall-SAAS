# Partywall - Cursor Rules

## üìã Contexte du Projet

Partywall est une application web React en temps r√©el qui permet aux invit√©s d'un √©v√©nement de partager instantan√©ment leurs photos sur grand √©cran. L'application utilise l'IA (Google Gemini) pour mod√©rer, am√©liorer et l√©gender automatiquement chaque photo.

**Objectifs principaux** :
- Exp√©rience photobooth interactive pour √©v√©nements
- Affichage temps r√©el sur grand √©cran
- Mod√©ration automatique par IA
- Administration compl√®te pour les organisateurs

---

## üõ† Stack Technique

### Frontend
- **React 19.2** : Composants fonctionnels avec Hooks, Suspense, Lazy Loading
- **TypeScript 5.8** : Typage strict, √©viter `any`
- **Vite 6.2** : Build tool avec HMR
- **Tailwind CSS 4.1** : Utility-first CSS
- **Lucide React** : Ic√¥nes

### Backend & Infrastructure
- **Supabase** : BaaS (PostgreSQL, Storage, Realtime, Auth)
  - PostgreSQL : Base de donn√©es relationnelle avec RLS
  - Storage : Stockage de fichiers (photos, cadres, avatars)
  - Realtime : Synchronisation temps r√©el via WebSockets
  - Auth : Authentification JWT avec email/password
- **Google Gemini 3 Flash** : IA pour mod√©ration et l√©gendes
  - Mod√©ration de contenu automatique
  - G√©n√©ration de l√©gendes personnalis√©es
  - Analyse de qualit√© d'images

### Outils & Biblioth√®ques
- **JSZip** : Export ZIP de photos
- **File Saver** : T√©l√©chargement de fichiers c√¥t√© client
- **QRCode React** : G√©n√©ration de QR codes
- **Framer Motion** : Animations fluides et performantes
- **Face-api.js** : Reconnaissance faciale
- **@tanstack/react-virtual** : Virtualisation pour performances

---

## üìê Architecture

### Structure des Dossiers
```
components/     # Composants UI React (un composant par fichier)
services/       # Logique m√©tier et int√©grations API
utils/          # Utilitaires (validation, filtres, overlays)
context/        # Contextes React (ToastContext)
types.ts        # Types TypeScript partag√©s
constants.ts    # Constantes globales
```

### Patterns Architecturaux
- **Service Layer Pattern** : Toute la logique m√©tier dans `/services`, les composants restent "stupides"
- **Context API** : Pour l'√©tat global partag√© (Event, Photos, Settings, Auth, Toast)
- **Lazy Loading** : Tous les composants principaux sont lazy-loaded avec React.lazy()
- **Type Safety** : TypeScript strict, types d√©finis dans `types.ts`
- **Multi-√©v√©nements** : Architecture SaaS avec table `events` et `event_id` partout
- **RLS (Row Level Security)** : S√©curit√© au niveau des lignes dans Supabase

---

## üíª Conventions de Code

### TypeScript
- ‚úÖ **Toujours utiliser TypeScript** pour nouveau code
- ‚úÖ **√âviter `any`** : Utiliser `unknown` ou types explicites
- ‚úÖ **Interfaces pour objets complexes** : D√©finir dans `types.ts` si partag√©
- ‚úÖ **JSDoc pour fonctions complexes** : Documenter les param√®tres et retours

**Exemple** :
```typescript
/**
 * Upload une photo vers Supabase Storage
 * @param base64Image - Image en base64
 * @param caption - L√©gende de la photo
 * @param author - Nom de l'auteur
 * @returns Promise r√©solue avec l'objet Photo cr√©√©
 */
export const addPhotoToWall = async (
  base64Image: string,
  caption: string,
  author: string
): Promise<Photo> => {
  // ...
};
```

### React
- ‚úÖ **Composants fonctionnels uniquement** : Pas de classes
- ‚úÖ **Hooks pour √©tat et effets** : `useState`, `useEffect`, `useContext`
- ‚úÖ **Props typ√©es** : Toujours d√©finir une interface pour les props
- ‚úÖ **Nommage PascalCase** : `GuestUpload`, `WallView`

**Exemple** :
```typescript
interface GuestUploadProps {
  onPhotoUploaded: (photo: Photo) => void;
  onBack: () => void;
}

export const GuestUpload: React.FC<GuestUploadProps> = ({
  onPhotoUploaded,
  onBack
}) => {
  // ...
};
```

### Nommage
- **Fichiers** : `camelCase.tsx` (composants), `camelCase.ts` (services/utils)
- **Composants** : `PascalCase`
- **Fonctions/Variables** : `camelCase`
- **Constantes** : `UPPER_SNAKE_CASE`
- **Types/Interfaces** : `PascalCase`

### Formatage
- **Indentation** : 2 espaces
- **Guillemets** : Simple quotes pour JS/TS, double pour JSX
- **Point-virgule** : Oui
- **Trailing commas** : Oui dans objets/arrays multilignes

---

## üèóÔ∏è Patterns de D√©veloppement

### Services
- **Isolation** : Chaque service encapsule une responsabilit√© (photoService, geminiService, etc.)
- **Erreurs** : G√©rer les erreurs avec try/catch, retourner des fallbacks pour services IA
- **Validation** : Valider les param√®tres d'entr√©e avant traitement

**Exemple** :
```typescript
export const addPhotoToWall = async (
  base64Image: string,
  caption: string,
  author: string
): Promise<Photo> => {
  if (!isSupabaseConfigured()) {
    throw new Error("Supabase n'est pas configur√©");
  }
  
  try {
    // Logique m√©tier
  } catch (error) {
    console.error("Error in addPhotoToWall:", error);
    throw error instanceof Error ? error : new Error("Erreur lors de l'upload");
  }
};
```

### Composants
- **S√©paration des responsabilit√©s** : UI dans composants, logique dans services
- **Props claires** : Nommer les props de mani√®re explicite
- **Gestion d'√©tat** : √âtat local avec `useState`, Context pour √©tat global partag√©
- **Lazy Loading** : Utiliser `React.lazy()` pour composants lourds

**Exemple** :
```typescript
// Dans App.tsx
const GuestUpload = lazy(() => import('./components/GuestUpload'));

// Utilisation avec Suspense
<Suspense fallback={<LoadingSpinner />}>
  <GuestUpload onPhotoUploaded={handleUpload} onBack={handleBack} />
</Suspense>
```

### Gestion d'Erreurs
- **Services** : Try/catch avec logging et propagation
- **Composants** : Afficher des toasts via `ToastContext` pour erreurs utilisateur
- **Fallbacks** : Services IA retournent des valeurs "safe" par d√©faut

**Exemple** :
```typescript
try {
  const caption = await generateImageCaption(base64);
  return caption;
} catch (error) {
  console.error("Error generating caption:", error);
  return "Party time! üéâ"; // Fallback
}
```

---

## üîí S√©curit√©

### Validation
- ‚úÖ **Valider tous les inputs** : Fichiers (taille, type MIME), texte (longueur, caract√®res)
- ‚úÖ **Sanitization** : Nettoyer les inputs pour pr√©venir XSS
- ‚úÖ **RLS Supabase** : Toujours v√©rifier que RLS est activ√© sur nouvelles tables

**Exemple** :
```typescript
export const validateImageFile = (file: File): { valid: boolean; error?: string } => {
  if (file.size > MAX_FILE_SIZE) {
    return { valid: false, error: 'Le fichier est trop volumineux (max 10MB)' };
  }
  if (!ALLOWED_IMAGE_TYPES.includes(file.type)) {
    return { valid: false, error: 'Type de fichier non autoris√©' };
  }
  return { valid: true };
};
```

### Variables d'Environnement
- ‚úÖ **Pr√©fixe `VITE_`** : Pour variables accessibles c√¥t√© client
- ‚úÖ **Ne jamais commiter `.env`** : D√©j√† dans `.gitignore`
- ‚úÖ **Validation au d√©marrage** : V√©rifier que les credentials sont pr√©sents

---

## üß™ Tests (√Ä Impl√©menter)

### Structure Future
- **Unit Tests** : Services avec mocks Supabase/Gemini
- **Integration Tests** : Flux complets (upload ‚Üí affichage)
- **E2E Tests** : Sc√©narios utilisateur (Playwright/Cypress)

### Bonnes Pratiques
- Tester les cas d'erreur (API down, validation √©chou√©e)
- Mocker les appels externes (Supabase, Gemini)
- Tester les edge cases (fichiers tr√®s gros, r√©seau lent)

---

## üìö Documentation

### Code Comments
- ‚úÖ **JSDoc pour fonctions publiques** : Services, utilitaires complexes
- ‚úÖ **Commentaires pour "pourquoi"** : Expliquer les d√©cisions, pas le "quoi"
- ‚úÖ **√âviter les commentaires √©vidents** : Le code doit √™tre auto-explicatif

### Documentation Utilisateur
- ‚úÖ **Mettre √† jour README.md** : Si nouvelle fonctionnalit√© utilisateur
- ‚úÖ **Mettre √† jour ARCHITECTURE.md** : Si modification architecturale
- ‚úÖ **Mettre √† jour API_DOCS.md** : Si nouveau service ou endpoint
- ‚úÖ **Mettre √† jour DB_SCHEMA.md** : Si modification base de donn√©es

---

## üö´ Anti-Patterns √† √âviter

### ‚ùå √Ä Ne Pas Faire
- ‚ùå **Logique m√©tier dans composants** : Extraire dans services
- ‚ùå **Props drilling excessif** : Utiliser Context si n√©cessaire
- ‚ùå **√âtat global inutile** : Pr√©f√©rer √©tat local quand possible
- ‚ùå **Re-renders inutiles** : Utiliser `useMemo`, `useCallback` si n√©cessaire
- ‚ùå **Appels API dans composants** : Utiliser les services
- ‚ùå **Types `any`** : Toujours typer explicitement
- ‚ùå **Composants trop gros** : Extraire en sous-composants
- ‚ùå **Duplication de code** : Extraire en fonctions/services r√©utilisables

### ‚úÖ √Ä Faire
- ‚úÖ **Composants petits et focalis√©s** : Une responsabilit√© par composant
- ‚úÖ **Services r√©utilisables** : Logique partag√©e dans services
- ‚úÖ **Types partag√©s** : D√©finir dans `types.ts`
- ‚úÖ **Constantes centralis√©es** : D√©finir dans `constants.ts`
- ‚úÖ **Gestion d'erreurs robuste** : Try/catch, fallbacks, logging

---

## üîÑ Workflows Communs

### Ajouter une Nouvelle Fonctionnalit√©
1. **Cr√©er le service** dans `/services` si logique m√©tier
2. **Cr√©er le composant** dans `/components` si UI
3. **D√©finir les types** dans `types.ts` si nouveaux types
4. **Ajouter les constantes** dans `constants.ts` si n√©cessaire
5. **Int√©grer dans App.tsx** avec lazy loading si composant principal
6. **Tester manuellement** : Upload, affichage, erreurs
7. **Mettre √† jour la documentation** si n√©cessaire

### Cr√©er un Nouveau Service
1. **Cr√©er le fichier** dans `/services/nomService.ts`
2. **Exporter les fonctions** avec types explicites
3. **G√©rer les erreurs** avec try/catch et fallbacks
4. **Valider les inputs** avant traitement
5. **Documenter avec JSDoc** si fonction complexe
6. **Tester manuellement** avec diff√©rents cas

### Ajouter une Table Supabase
1. **Cr√©er le script SQL** : `supabase_nom_table_setup.sql`
2. **Ajouter `event_id`** : Toutes les tables doivent avoir `event_id UUID REFERENCES events(id) ON DELETE CASCADE`
3. **D√©finir RLS** : Politiques SELECT, INSERT, UPDATE, DELETE avec filtres `event_id`
4. **Cr√©er les index** : Sur `event_id` et colonnes fr√©quemment requ√™t√©es
5. **Activer Realtime** : Si n√©cessaire pour temps r√©el (Dashboard Supabase > Replication)
6. **Cr√©er le service** : Fonctions CRUD dans `/services/nomService.ts`
7. **Mettre √† jour DB_SCHEMA.md** : Documenter la nouvelle table
8. **Tester les permissions** : V√©rifier RLS fonctionne correctement

### Modifier l'UI
1. **Identifier le composant** √† modifier
2. **V√©rifier les props** : S'assurer que les types sont corrects
3. **Modifier le JSX** : Utiliser Tailwind CSS pour le styling
4. **Tester responsive** : V√©rifier sur mobile et desktop
5. **Tester les interactions** : Clics, hovers, transitions

---

## üì¶ D√©pendances √† Favoriser

### Pour des T√¢ches Communes
- **Validation** : Utiliser les fonctions dans `/utils/validation.ts`
- **Filtres d'image** : Utiliser `/utils/imageFilters.ts`
- **Overlays/Cadres** : Utiliser `/utils/imageOverlay.ts`
- **Toasts** : Utiliser `ToastContext` pour notifications
- **Supabase** : Utiliser `supabaseClient.ts` pour toutes les op√©rations DB
- **Compression** : Utiliser `useImageCompression` hook pour optimiser les images
- **Debounce** : Utiliser `useDebounce` hook pour limiter les appels API
- **Logger** : Utiliser `logger` de `/utils/logger.ts` pour le logging structur√©

### Services Disponibles
- **photoService.ts** : CRUD photos, likes, r√©actions, upload
- **eventService.ts** : Gestion √©v√©nements, organisateurs
- **guestService.ts** : Gestion invit√©s, blocage
- **geminiService.ts** : Mod√©ration IA, l√©gendes, analyse qualit√©
- **settingsService.ts** : Param√®tres d'√©v√©nement
- **battleService.ts** : Battles photos
- **exportService.ts** : Export ZIP
- **aftermovieService.ts** : G√©n√©ration vid√©os timelapse
- **photoboothService.ts** : Upload photobooth avec traitement complet
- **faceRecognitionService.ts** : Reconnaissance faciale
- **frameService.ts** : Gestion cadres d√©coratifs
- **gamificationService.ts** : Badges, classements

### Biblioth√®ques √† √âviter
- ‚ùå **√âtat global lourd** : Redux/Zustand (pas n√©cessaire actuellement)
- ‚ùå **Formulaires complexes** : React Hook Form (pas encore n√©cessaire)
- ‚ùå **Routing** : React Router (routing manuel actuellement)
- ‚ùå **State management externe** : Context API suffit pour la taille actuelle

---

## üéØ Objectifs de Qualit√©

### Code Quality
- **Lisibilit√©** : Code auto-explicatif, noms clairs
- **Maintenabilit√©** : Structure claire, documentation
- **Performance** : Lazy loading, optimisation des re-renders
- **S√©curit√©** : Validation, sanitization, RLS

### Exp√©rience Utilisateur
- **Feedback** : Toasts pour toutes les actions importantes
- **Performance** : Chargement rapide, transitions fluides
- **Accessibilit√©** : Labels, ARIA (√† am√©liorer)
- **Mobile-first** : Interface responsive et optimis√©e mobile

---

## üîç V√©rifications Avant Commit

- [ ] Code suit les conventions (nommage, formatage)
- [ ] Types TypeScript corrects (pas d'erreurs, pas de `any`)
- [ ] Gestion d'erreurs appropri√©e (try/catch, fallbacks pour IA)
- [ ] Tests manuels effectu√©s (upload, affichage, erreurs)
- [ ] Documentation mise √† jour si n√©cessaire (README, ARCHITECTURE, API_DOCS, DB_SCHEMA)
- [ ] Pas de `console.log` oubli√©s (utiliser `logger` de `/utils/logger.ts`)
- [ ] Pas de code comment√© mort
- [ ] Variables d'environnement v√©rifi√©es (pas de secrets dans le code)
- [ ] RLS Supabase v√©rifi√© si nouvelle table
- [ ] `event_id` ajout√© si nouvelle table (architecture multi-√©v√©nements)

---

## üìñ Ressources

- **Documentation Supabase** : https://supabase.com/docs
- **Documentation React** : https://react.dev
- **Documentation Gemini** : https://ai.google.dev/docs
- **Documentation Vite** : https://vitejs.dev
- **Documentation Tailwind** : https://tailwindcss.com/docs

---

**Derni√®re mise √† jour** : 2026-01-15
